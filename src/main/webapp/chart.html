<!DOCTYPE html>
<html>
<head>
    <title>Chart</title>
    <link href="icon.png" rel="icon"/>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link crossorigin="anonymous" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.min.css" rel="stylesheet">
    <link href="/my_chartist.css" rel="stylesheet">
    <link href="/my_chartist-plugins.legend.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script crossorigin="anonymous"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.0/chartist.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist-plugin-legend/0.6.2/chartist-plugin-legend.js"></script>
    <script src="chartist-plugin-axistitle.js"></script>

</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-light mb-1">
    <img alt="" class="d-inline-block align-top" height="30" src="/icon.png" width="30">
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="/.">Home</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="/chart.html">Chart</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/videogames.html">Dynamic table</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/VideoGamesServlet">Static table</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container mb-1">
    <div class="row justify-content-md-center">
        <div class="col-2">
            <form id="sales_type_form">
                <div class="form-group">
                    <label for="sales_type_form_select">
                        <select class="form-control" id="sales_type_form_select">
                            <option name="sales_type" value="Global_Sales">Global sales</option>
                            <option name="sales_type" value="EU_Sales">EU sales</option>
                            <option name="sales_type" value="NA_Sales">NA sales</option>
                            <option name="sales_type" value="JP_Sales">JP sales</option>
                            <option name="sales_type" value="Other_Sales">Other sales</option>
                        </select>
                    </label>
                </div>
            </form>
        </div>
        <div class="col-1"><p class="h3">By</p></div>
        <div class="col-2">
            <form id="group_field_form">
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-secondary active">
                        <input autocomplete="off" checked id="Platform" name="group_field" type="radio"
                               value="Platform">
                        Platform
                    </label>
                    <label class="btn btn-secondary">
                        <input autocomplete="off" id="Genre" name="group_field" type="radio" value="Genre   "> Genre
                    </label>
                </div>
            </form>
        </div>
    </div>
    <div class="ct-chart-line" id="chart"></div>
</div>


<script>
    var chart_params = {
        sales_type: "Global_Sales",
        group_field: "Platform"
    };

    function insert_chart() {
        $("#chart").empty();
        var series = [];
        var serie = [];
        var labels = [];
        $.ajax(
            "/api/videoGames/grouped" +
            "?sales_type=" + chart_params.sales_type +
            "&group_field=" + chart_params.group_field
        )
            .done(function (arg) {
                var years = arg[0];
                $.each(arg[1], function (group_field, data) {
                    var dic = {"name": group_field === undefined || group_field === "" ? "Uknown" : group_field};
                    serie = [];
                    $.each(years, function (index, year) {
                        serie.push({x: year, y: data[year]});
                    });
                    dic["data"] = serie;
                    series.push(dic);
                });

                // creaating space between labels
                $.each(years, function (index, year) {
                    labels.push(year % 2 == 0 ? year : "");
                });

                var chart_data = {
                    labels: labels,
                    series: series
                };
                var chart_options = {
                    showPoint: false,
                    fullWidth: true,
                    width: "100%",
                    height: "400px",
                    low: 0,
                    chartPadding: {
                        right: 40,
                        left: 40,
                        top: 10
                    },
                    axisY: {
                        type: Chartist.AutoScaleAxis
                    },
                    lineSmooth: Chartist.Interpolation.cardinal({
                        fillHoles: true,
                    }),
                    plugins: [
                        Chartist.plugins.legend({
                            position: 'bottom',
                            className: 'mt-3'
                        }),
                        Chartist.plugins.ctAxisTitle({
                            axisX: {
                                axisTitle: 'Years',
                                axisClass: 'ct-axis-title',
                                offset: {
                                    x: 0,
                                    y: 35
                                },
                                textAnchor: 'middle'
                            },
                            axisY: {
                                axisTitle: 'Sales $',
                                axisClass: 'ct-axis-title',
                                offset: {
                                    x: 0,
                                    y: -20
                                },
                                textAnchor: 'middle',
                                flipTitle: false
                            }
                        })
                    ]
                };
                new Chartist.Line('.ct-chart-line', chart_data, chart_options);
            })
            .fail(function () {
                alert("error");
            });
    }

    $('#group_field_form input').change(function () {
        chart_params.group_field = $('input[name=group_field]:checked', '#group_field_form').val();
        insert_chart();
    });

    $('#sales_type_form_select').change(function () {
        chart_params.sales_type = $("#sales_type_form_select option:selected").val();
        insert_chart();
    });
    $(document).ready(function () {
        insert_chart();
    });

</script>
</body>
</html>
